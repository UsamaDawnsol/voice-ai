<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process.env Fix Test - Voice AI Widget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-results {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .admin-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #007bff;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Process.env Fix Test - Voice AI Widget</h1>
        
        <div class="info">
            <h3>‚úÖ Process.env Client-Side Fix Applied:</h3>
            <ul>
                <li>‚úÖ Removed `process.env` from client-side code</li>
                <li>‚úÖ Added `appUrl` to loader data</li>
                <li>‚úÖ Used settings data instead of process.env</li>
                <li>‚úÖ Made embed code generation client-safe</li>
                <li>‚úÖ Fixed ReferenceError: process is not defined</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>üß™ Test Instructions:</h3>
            <ol>
                <li>Check if admin panel loads without process.env errors</li>
                <li>Test embed code generation</li>
                <li>Test widget settings form</li>
                <li>Test copy to clipboard functionality</li>
                <li>Check console for any errors</li>
            </ol>
        </div>
        
        <div id="status" class="status info">
            Loading process.env fix test...
        </div>
        
        <div class="test-section">
            <h3>üîß Test Controls:</h3>
            <button class="test-button" onclick="testProcessEnv()">Test Process.env</button>
            <button class="test-button" onclick="testEmbedCode()">Test Embed Code</button>
            <button class="test-button" onclick="testAdminPanel()">Test Admin Panel</button>
            <button class="test-button" onclick="checkErrors()">Check Errors</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Results:</h3>
            <div id="test-results" class="test-results">No tests run yet...</div>
        </div>
        
        <div class="test-section">
            <h3>üêõ Debug Information:</h3>
            <div id="debug"></div>
        </div>
        
        <!-- Simulated Admin Panel -->
        <div class="admin-panel">
            <h3>üéõÔ∏è Simulated Admin Panel</h3>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="enable-widget" checked>
                    <label for="enable-widget">Enable Voice AI Widget</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="bg-color">Background Color:</label>
                <input type="color" id="bg-color" value="#007bff">
            </div>
            
            <div class="form-group">
                <label for="icon-color">Icon Color:</label>
                <input type="color" id="icon-color" value="#ffffff">
            </div>
            
            <div class="form-group">
                <label for="position">Position:</label>
                <select id="position">
                    <option value="right" selected>Right Side</option>
                    <option value="left">Left Side</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Embed Code (Client-Safe):</label>
                <div class="test-results" id="embed-code">
                    <script src="https://your-app.com/embed?shop=test-shop.myshopify.com&t=1234567890"></script>
                </div>
                <button class="test-button" onclick="copyEmbedCode()">Copy Code</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìù Process.env Fix Details:</h3>
            <div class="code-block">
// Before (causing client-side error):
const updateEmbedCode = () => {
  return `<script src="${process.env.SHOPIFY_APP_URL}/embed?shop=${shop}"></script>`;
};

// After (client-safe):
// In loader (server-side):
const currentSettings = {
  // ... other settings
  appUrl: process.env.SHOPIFY_APP_URL, // Server-side only
  embedCode: `<script src="${process.env.SHOPIFY_APP_URL}/embed?shop=${session.shop}"></script>`
};

// In component (client-side):
const updateEmbedCode = () => {
  return `<script src="${settings.appUrl}/embed?shop=${settings.shop}&t=${timestamp}"></script>`;
};
            </div>
        </div>
    </div>

    <script>
        let testResults = [];
        
        // Simulate settings data (as would come from loader)
        const settings = {
            backgroundColor: '#007bff',
            iconColor: '#ffffff',
            position: 'right',
            isActive: true,
            shop: 'test-shop.myshopify.com',
            appUrl: 'https://your-app.com', // This would come from server
            embedCode: '<script src="https://your-app.com/embed?shop=test-shop.myshopify.com"></script>'
        };
        
        // Test functions
        function testProcessEnv() {
            // Test if process.env is accessible (it shouldn't be in browser)
            if (typeof process !== 'undefined' && process.env) {
                addTestResult('‚ùå Process.env Test: FAILED - process.env is accessible in browser (security issue)');
            } else {
                addTestResult('‚úÖ Process.env Test: PASSED - process.env not accessible in browser (secure)');
            }
            
            // Test if we can access appUrl from settings
            if (settings.appUrl) {
                addTestResult('‚úÖ AppUrl Test: PASSED - appUrl available from settings');
            } else {
                addTestResult('‚ùå AppUrl Test: FAILED - appUrl not available from settings');
            }
        }
        
        function testEmbedCode() {
            // Test embed code generation without process.env
            try {
                const timestamp = Date.now();
                const embedCode = `<script src="${settings.appUrl}/embed?shop=${settings.shop}&t=${timestamp}"></script>`;
                
                if (embedCode.includes(settings.appUrl) && embedCode.includes(settings.shop)) {
                    addTestResult('‚úÖ Embed Code Test: PASSED - Embed code generated without process.env');
                    
                    // Update display
                    document.getElementById('embed-code').innerHTML = embedCode;
                } else {
                    addTestResult('‚ùå Embed Code Test: FAILED - Embed code not generated correctly');
                }
            } catch (error) {
                addTestResult(`‚ùå Embed Code Test: FAILED - Error: ${error.message}`);
            }
        }
        
        function testAdminPanel() {
            // Test if admin panel elements are accessible
            const enableWidget = document.getElementById('enable-widget');
            const bgColor = document.getElementById('bg-color');
            const iconColor = document.getElementById('icon-color');
            const position = document.getElementById('position');
            
            if (enableWidget && bgColor && iconColor && position) {
                addTestResult('‚úÖ Admin Panel Test: PASSED - All form elements found');
            } else {
                addTestResult('‚ùå Admin Panel Test: FAILED - Form elements not found');
            }
            
            // Test if no process.env errors
            if (typeof process === 'undefined') {
                addTestResult('‚úÖ Admin Panel Test: PASSED - No process.env errors');
            } else {
                addTestResult('‚ùå Admin Panel Test: FAILED - process.env errors detected');
            }
        }
        
        function checkErrors() {
            const errorCount = window.errorCount || 0;
            if (errorCount === 0) {
                addTestResult('‚úÖ Error Check: PASSED - No errors detected');
            } else {
                addTestResult(`‚ùå Error Check: FAILED - ${errorCount} errors detected`);
            }
        }
        
        function copyEmbedCode() {
            const embedCode = document.getElementById('embed-code').textContent;
            
            if (typeof navigator !== 'undefined' && navigator.clipboard) {
                navigator.clipboard.writeText(embedCode).then(() => {
                    addTestResult('‚úÖ Copy Test: PASSED - Code copied to clipboard');
                }).catch(() => {
                    addTestResult('‚ùå Copy Test: FAILED - Could not copy to clipboard');
                });
            } else {
                addTestResult('‚ö†Ô∏è Copy Test: WARNING - Clipboard API not available');
            }
        }
        
        function addTestResult(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateTestResults();
        }
        
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.join('<br>');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Check process.env fix status
        setTimeout(() => {
            const status = document.getElementById('status');
            const debug = document.getElementById('debug');
            
            status.innerHTML = '‚úÖ Process.env fix test loaded successfully!';
            status.className = 'status success';
            debug.innerHTML = 'Process.env fix test initialized. No client-side process.env errors.';
            
            addTestResult('‚úÖ Initialization: PASSED - Process.env fix test loaded successfully');
        }, 1000);
        
        // Monitor errors
        window.errorCount = 0;
        window.addEventListener('error', function(e) {
            window.errorCount++;
            console.error('Error:', e.error);
            const debug = document.getElementById('debug');
            debug.innerHTML += `<br>Error: ${e.message}`;
            addTestResult(`‚ùå Error: ${e.message}`);
        });
        
        console.log('Process.env Fix Test Page Loaded');
        console.log('Settings:', settings);
        addTestResult('üöÄ Test page loaded successfully');
        
        // Auto-run tests
        setTimeout(() => {
            testProcessEnv();
            testEmbedCode();
            testAdminPanel();
        }, 2000);
    </script>
</body>
</html>
